<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klubbens Webbplats</title>
    <!-- Använd Tailwind CSS för en snygg och responsiv design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        /* Modal-styling för felmeddelanden och bekräftelse */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .modal-close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style för den enkla redigeraren */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap; /* Gör att knapparna kan radbrytas på små skärmar */
        }
        .editor-toolbar button {
            transition: background-color 0.2s;
        }
        .editor-toolbar .active {
            background-color: #cbd5e1; /* Tailwind 'slate-300' för aktiv knapp */
        }
        .editor-content {
            min-height: 150px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            outline: none;
        }
        /* Stilar för Markdown-innehåll */
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content a {
            color: #2563eb;
            text-decoration: underline;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        /* Kalenderpost-styling för klickbarhet */
        .calendar-post {
            cursor: pointer;
        }
        .calendar-post-expanded {
            display: block;
        }
        .gallery-image {
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>

    <!-- Header och navigering -->
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container py-4 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <a href="#" class="text-3xl font-bold tracking-tight">Kumla Skytteförening</a>
                <p class="text-sm text-gray-300 mt-1">Ver. 1.31</p>
            </div>
            <nav>
                <ul class="flex space-x-4 font-medium">
                    <li><a href="#hem" class="hover:text-gray-300 transition duration-300">Hem</a></li>
                    <li><a href="#nyheter" class="hover:text-gray-300 transition duration-300">Nyheter</a></li>
                    <li><a href="#kalender" class="hover:text-gray-300 transition duration-300">Kalender</a></li>
                    <li><a href="#bilder" class="hover:text-gray-300 transition duration-300">Bilder</a></li>
                    <li><a href="#admin" class="hover:text-gray-300 transition duration-300">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Huvudinnehåll -->
    <main class="container">

        <!-- Sida: Hem -->
        <section id="hem" class="page active">
            <div class="bg-blue-100 p-8 rounded-xl text-center mb-8">
                <h1 class="text-4xl font-extrabold text-blue-900 mb-4">Välkommen till Kumla Skytteförening!</h1>
                <p class="text-lg text-blue-700">Vi är en klubb för entusiaster av skytte. Här kan du hitta information om vår historia, nyheter och kommande evenemang.</p>
            </div>
            
            <h2 class="text-3xl font-bold mb-4">Senaste Nyheterna</h2>
            <div id="home-news-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nyheter kommer att renderas här av JavaScript -->
            </div>
            
            <h2 class="text-3xl font-bold mt-8 mb-4">Kommande Evenemang</h2>
            <div id="home-events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Kalenderhändelser kommer att renderas här av JavaScript -->
            </div>

            <h2 class="text-3xl font-bold mt-8 mb-4">Klubbens Poster</h2>
            <div id="home-history-container" class="space-y-6">
                <!-- Historieposter renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Nyheter -->
        <section id="nyheter" class="page">
            <h1 class="text-4xl font-bold mb-6">Alla Nyheter</h1>
            <div id="all-news-container" class="space-y-6">
                <!-- Nyheter kommer att renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Kalender -->
        <section id="kalender" class="page">
            <h1 class="text-4xl font-bold mb-6">Kalender</h1>
            <div id="calendar-container" class="space-y-6">
                <!-- Kalenderhändelser kommer att renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Bilder -->
        <section id="bilder" class="page">
            <h1 class="text-4xl font-bold mb-6">Bildgalleri</h1>
            <div id="gallery-container">
                <!-- Bilder kommer att renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Admin -->
        <section id="admin" class="page">
            <div id="admin-login-panel" class="card max-w-md mx-auto">
                <h1 class="text-2xl font-bold mb-4">Admininloggning</h1>
                <input type="text" id="admin-username" placeholder="Användarnamn" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="password" id="admin-password" placeholder="Lösenord" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Logga in</button>
            </div>

            <div id="admin-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-4xl font-bold">Administrationspanel</h1>
                    <button id="logout-btn" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300">Logga ut</button>
                </div>
                <div id="admin-user-info" class="mb-4 text-sm text-gray-500"></div>
                
                <!-- Adminhantering -->
                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4">Adminhantering</h2>
                    <form id="add-admin-form">
                        <label for="new-admin-username" class="block mb-2 font-semibold">Nytt Admin-användarnamn</label>
                        <input type="text" id="new-admin-username" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        <label for="new-admin-password" class="block mb-2 font-semibold">Nytt Admin-lösenord</label>
                        <input type="password" id="new-admin-password" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        <button type="submit" id="add-admin-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">Lägg till Admin</button>
                    </form>
                    
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-2">Befintliga administratörer</h3>
                        <div id="admin-list" class="space-y-2">
                            <!-- Administratörer renderas här -->
                        </div>
                    </div>
                </div>

                <!-- Formulär för Historieposter -->
                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4" id="history-form-title">Lägg till Huvudsidposter</h2>
                    <form id="add-history-form">
                        <label for="history-title" class="block mb-2 font-semibold">Titel</label>
                        <input type="text" id="history-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <label for="history-content" class="block mb-2 font-semibold">Innehåll</label>
                        <div class="editor-toolbar" data-editor-target="history-content-editor">
                            <button type="button" data-command="bold" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 font-bold">B</button>
                            <button type="button" data-command="italic" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 italic">I</button>
                            <button type="button" data-command="createLink" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Länk</button>
                            <button type="button" data-command="insertImage" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Bild</button>
                        </div>
                        <div id="history-content-editor" contenteditable="true" class="editor-content w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></div>
                        <input type="hidden" id="history-content-hidden">
                        
                        <button type="submit" id="add-history-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till</button>
                    </form>
                </div>

                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4" id="news-form-title">Lägg till Nyhet</h2>
                    <form id="add-news-form">
                        <label for="news-title" class="block mb-2 font-semibold">Titel</label>
                        <input type="text" id="news-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <label for="news-date" class="block mb-2 font-semibold">Datum</label>
                        <input type="date" id="news-date" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <label for="news-content" class="block mb-2 font-semibold">Innehåll</label>
                        <div class="editor-toolbar" data-editor-target="news-content-editor">
                            <button type="button" data-command="bold" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 font-bold">B</button>
                            <button type="button" data-command="italic" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 italic">I</button>
                            <button type="button" data-command="createLink" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Länk</button>
                            <button type="button" data-command="insertImage" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Bild</button>
                        </div>
                        <div id="news-content-editor" contenteditable="true" class="editor-content w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></div>
                        <input type="hidden" id="news-content-hidden">
                        
                        <button type="submit" id="add-news-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till</button>
                    </form>
                </div>

                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4">Lägg till Kalenderhändelse</h2>
                    <form id="add-event-form">
                        <label for="event-title" class="block mb-2 font-semibold">Titel</label>
                        <input type="text" id="event-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <!-- Välj om händelsen är återkommande eller inte -->
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="is-recurring" class="mr-2">
                            <label for="is-recurring" class="font-semibold">Återkommande händelse</label>
                        </div>

                        <!-- Fält för engångshändelse -->
                        <div id="single-event-fields">
                            <label for="event-date" class="block mb-2 font-semibold">Datum</label>
                            <input type="date" id="event-date" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        </div>

                        <!-- Fält för återkommande händelse -->
                        <div id="recurring-event-fields" class="hidden">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="start-date" class="block mb-2 font-semibold">Startdatum</label>
                                    <input type="date" id="start-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="end-date" class="block mb-2 font-semibold">Slutdatum</label>
                                    <input type="date" id="end-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <label class="block mb-2 font-semibold">Veckodag</label>
                            <select id="weekday-select" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                                <option value="1">Måndag</option>
                                <option value="2">Tisdag</option>
                                <option value="3">Onsdag</option>
                                <option value="4">Torsdag</option>
                                <option value="5">Fredag</option>
                                <option value="6">Lördag</option>
                                <option value="0">Söndag</option>
                            </select>
                        </div>

                        <label for="event-description" class="block mb-2 font-semibold">Beskrivning</label>
                        <div class="editor-toolbar" data-editor-target="event-description-editor">
                            <button type="button" data-command="bold" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 font-bold">B</button>
                            <button type="button" data-command="italic" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 italic">I</button>
                            <button type="button" data-command="createLink" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Länk</button>
                            <button type="button" data-command="insertImage" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Bild</button>
                        </div>
                        <div id="event-description-editor" contenteditable="true" class="editor-content w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></div>
                        <input type="hidden" id="event-description-hidden">

                        <button type="submit" id="add-event-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till</button>
                    </form>
                </div>

                <!-- Formulär för att lägga till bilder -->
                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4" id="image-form-title">Lägg till Bild</h2>
                    <form id="add-image-form">
                        <label for="image-title" class="block mb-2 font-semibold">Titel/Beskrivning</label>
                        <input type="text" id="image-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        <label for="image-url" class="block mb-2 font-semibold">Bild-URL</label>
                        <input type="url" id="image-url" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="image-year" class="block mb-2 font-semibold">År</label>
                                <input type="number" id="image-year" required value="${new Date().getFullYear()}" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                            </div>
                            <div>
                                <label for="image-month" class="block mb-2 font-semibold">Månad</label>
                                <select id="image-month" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                                    <option value="1">Januari</option>
                                    <option value="2">Februari</option>
                                    <option value="3">Mars</option>
                                    <option value="4">April</option>
                                    <option value="5">Maj</option>
                                    <option value="6">Juni</option>
                                    <option value="7">Juli</option>
                                    <option value="8">Augusti</option>
                                    <option value="9">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" id="add-image-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till Bild</button>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- Modal för felmeddelanden -->
        <div id="errorModal" class="modal">
            <div class="modal-content">
                <span id="close-error-modal" class="modal-close-btn">&times;</span>
                <p id="error-message" class="text-lg font-semibold text-red-600"></p>
            </div>
        </div>

        <!-- Bekräftelse-modal -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <p id="confirmation-message" class="text-lg font-semibold text-green-600"></p>
            </div>
        </div>
        
        <!-- Raderingsmodal för kalenderhändelser och nyheter -->
        <div id="deleteConfirmationModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Bekräfta borttagning</h3>
                <p id="delete-confirmation-message" class="mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Ja</button>
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

        <!-- Raderingsmodal för kalenderhändelser -->
        <div id="deleteEventModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Radera händelse</h3>
                <p id="delete-event-message" class="mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="delete-single-event-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Radera enskild händelse</button>
                    <button id="delete-series-event-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Radera hel serie</button>
                    <button id="cancel-event-delete-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

        <!-- Modal för att dela nyhet -->
        <div id="shareModal" class="modal">
            <div class="modal-content">
                <span id="close-share-modal" class="modal-close-btn">&times;</span>
                <h3 class="text-xl font-bold mb-4">Dela nyhet</h3>
                <p id="share-message" class="mb-4 text-sm"></p>
                <div class="flex flex-col space-y-4 sm:flex-row sm:space-x-4 sm:space-y-0 mt-4 justify-center">
                    <a id="share-facebook-btn" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300 cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.542-1.333h2.458v-4h-3c-3.153 0-4 1.258-4 3.75v1.25z"/>
                        </svg>
                        <span class="ml-2">Dela på Facebook</span>
                    </a>
                    <button id="copy-link-btn" class="flex items-center justify-center px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8.463 11.233c-.768.768-1.042 1.942-.519 3.033l-1.378 1.378c-.781-2.454.124-4.834 1.705-6.415l1.378-1.378c1.674-1.674 4.093-2.146 6.415-1.705l-1.378 1.378c-1.091-.523-2.265-.249-3.033.519l-1.705 1.705c-.768.768-1.042 1.942-.519 3.033l-1.378 1.378c-.781-2.454.124-4.834 1.705-6.415l1.378-1.378z"/>
                        </svg>
                        <span class="ml-2">Kopiera länk</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal för att lägga till bild -->
        <div id="insertImageModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Infoga bild</h3>
                <label for="image-url-input" class="block mb-2 font-semibold">Bild-URL</label>
                <input type="url" id="image-url-input" placeholder="https://exempel.se/bild.jpg" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                
                <label for="image-size-select" class="block mb-2 font-semibold">Storlek</label>
                <select id="image-size-select" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                    <option value="small">Liten (150px)</option>
                    <option value="medium" selected>Medium (400px)</option>
                    <option value="large">Stor (800px)</option>
                    <option value="original">Originalstorlek</option>
                </select>

                <div class="flex justify-center space-x-4">
                    <button id="insert-image-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Infoga</button>
                    <button id="cancel-image-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-blue-800 text-white text-center py-4 mt-8">
        <div class="container text-sm flex flex-col sm:flex-row justify-between items-center">
            <p class="font-bold">Kumla Skytteförening</p>
            <div class="mt-2 sm:mt-0">
                <a href="https://www.facebook.com/Kumlaskytte/" target="_blank" rel="noopener noreferrer" class="text-white hover:text-gray-300 transition duration-300 mx-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.542-1.333h2.458v-4h-3c-3.153 0-4 1.258-4 3.75v1.25z"/>
                    </svg>
                </a>
            </div>
            <p class="mt-2 sm:mt-0">Adress: Viagatan 5, Kumla, Sweden</p>
            <p class="mt-2 sm:mt-0">Telefon: 073-088 57 25</p>
            <p class="mt-2 sm:mt-0">Grundad: 1904</p>
        </div>
    </footer>
    
    <!-- Firebase SDK-skript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc, query, where, getDocs, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { updateDoc as updateDocFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCorCZf8cH8vD1v47aOADdW3x0hCWlVUfw",
            authDomain: "kumlaskytte.firebaseapp.com",
            projectId: "kumlaskytte",
            storageBucket: "kumlaskytte.firebasestorage.app",
            messagingSenderId: "571676149705",
            appId: "1:571676149705:web:a0ace868f4680298a78a18",
            measurementId: "G-KSJ9NLNDBX"
        };

        const firebaseConfigExists = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey.length > 0;
        let db;
        let auth;
        let isAdminLoggedIn = false;
        let loggedInAdminUsername = '';
        let newsData = [];
        let eventsData = [];
        let adminsData = [];
        let historyData = [];
        let imageData = []; 
        let editingNewsId = null; 
        let editingHistoryId = null;
        let editingImageId = null;
        let currentUserId = null;

        // --- MODAL FUNCTIONS ---
        function showModal(modalId, message) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const messageEl = modal.querySelector('p');
            if (messageEl) {
                messageEl.innerHTML = message;
            }
            modal.classList.add('active');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('active');
        }

        // Function to extract the first line of text from HTML content
        function getFirstLineText(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const firstChild = tempDiv.firstElementChild;
            if (firstChild && firstChild.tagName === 'P') {
                return firstChild.textContent;
            }
            return tempDiv.textContent.split('\n')[0].trim();
        }

        // Function to extract the first image from HTML content
        function getFirstImage(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const firstImage = tempDiv.querySelector('img');
            return firstImage ? firstImage.outerHTML : '';
        }

        // --- CONTENT RENDERING ---
        function renderNews() {
            const news = newsData;
            const homeNewsContainer = document.getElementById('home-news-container');
            const allNewsContainer = document.getElementById('all-news-container');

            if (!homeNewsContainer || !allNewsContainer) return;

            homeNewsContainer.innerHTML = '';
            allNewsContainer.innerHTML = '';

            // Sortera nyheterna efter det angivna datumet
            news.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;
            });
            
            // Render the 2 latest news items on the home page
            news.slice(0, 2).forEach(item => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' });
                const firstLine = getFirstLineText(item.content);
                const firstImage = getFirstImage(item.content);
                const likes = item.likes || {};
                const likeCount = Object.keys(likes).length;
                const userHasLiked = currentUserId && likes[currentUserId];
                
                let imageHtml = '';
                if (firstImage) {
                    const tempImgDiv = document.createElement('div');
                    tempImgDiv.innerHTML = firstImage;
                    const img = tempImgDiv.querySelector('img');
                    img.setAttribute('style', 'width: 150px; height: auto;');
                    img.classList.add('rounded-lg', 'object-cover', 'mr-4');
                    imageHtml = `<div class="flex-shrink-0">${img.outerHTML}</div>`;
                }
                
                const shortContent = firstLine.length > 150 ? firstLine.substring(0, 150) + '...' : firstLine;


                homeNewsContainer.innerHTML += `
                    <div class="card flex items-start news-post home-news-post cursor-pointer" data-id="${item.id}">
                        ${imageHtml}
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                            <p class="text-sm text-gray-500 mb-2">Publicerad: ${formattedDate}</p>
                            <div class="text-gray-700 markdown-content">${shortContent}</div>
                        </div>
                    </div>
                `;
            });

            // Render all news items on the news page
            news.forEach(item => {
                const date = new Date(item.date);
                const createdAt = item.createdAt?.toDate() || new Date();
                const updatedAt = item.updatedAt?.toDate() || createdAt;
                const formattedDate = date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' });
                const likes = item.likes || {};
                const likeCount = Object.keys(likes).length;
                const userHasLiked = currentUserId && likes[currentUserId];
                const timeInfo = `Upplagt: ${createdAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${createdAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}. Senast redigerad: ${updatedAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${updatedAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}`;

                allNewsContainer.innerHTML += `
                    <div class="card" id="news-${item.id}">
                        <h3 class="text-2xl font-semibold mb-2">${item.title}</h3>
                        <p class="text-sm text-gray-500 mb-2">${timeInfo}</p>
                        <div class="text-gray-700 markdown-content">${item.content}</div>
                        <div class="flex items-center space-x-2 mt-4">
                            <button class="like-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-300 ${userHasLiked ? 'text-blue-500' : ''}" data-id="${item.id}" data-type="news" data-liked="${userHasLiked}">
                                👍 <span class="like-count">${likeCount}</span>
                            </button>
                            <button class="share-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-300" data-id="${item.id}" data-title="${item.title}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.314l4.94 2.47a3 3 0 10.96.168.25.25 0 01.192.327l-.07.292-.195.071c-.563.205-.96.721-.96 1.302a.25.25 0 00.327.192l.292-.07-.07-.195c.581.042 1.139-.247 1.302-.96l.07-.292-.195-.071a3 3 0 00-.765-.365l-4.94-2.47c-1.091.523-2.265.249-3.033-.519l-1.705-1.705c-.768-.768-1.042-1.942-.519-3.033l1.378-1.378c1.674-1.674 4.093-2.146 6.415-1.705l-1.378 1.378z"/>
                                </svg>
                                <span class="ml-1 hidden sm:inline">Dela</span>
                            </button>
                            ${isAdminLoggedIn ? `
                                <button class="delete-btn px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="news">Ta bort</button>
                                <button class="edit-news-btn px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300" data-id="${item.id}">Ändra</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }
        
        function renderEvents() {
            const events = eventsData;
            const calendarContainer = document.getElementById('calendar-container');
            const homeEventsContainer = document.getElementById('home-events-container');

            if (!calendarContainer || !homeEventsContainer) return;

            calendarContainer.innerHTML = '';
            homeEventsContainer.innerHTML = '';
            
            // Sort events by date and filter out old events
            const today = new Date().toISOString().split('T')[0];
            const upcomingEvents = events.filter(e => e.date >= today);
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date)); 

            // Render the 2 next upcoming events on the home page
            upcomingEvents.slice(0, 2).forEach(item => {
                const eventDate = new Date(item.date);
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('sv-SE', { month: 'short' });
                
                homeEventsContainer.innerHTML += `
                    <div class="card flex items-start calendar-post home-calendar-post" data-id="${item.id}">
                        <div class="flex-shrink-0 bg-blue-500 text-white font-bold p-4 rounded-lg text-center mr-4">
                            <p class="text-xl leading-none">${day}</p>
                            <p class="text-xs uppercase">${month}</p>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                        </div>
                    </div>
                `;
            });


            upcomingEvents.forEach(item => {
                const eventDate = new Date(item.date);
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('sv-SE', { month: 'short' });
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = item.description;
                const shortText = tempDiv.firstElementChild && tempDiv.firstElementChild.tagName === 'P' ? tempDiv.firstElementChild.innerHTML : tempDiv.innerHTML;
                const createdAt = item.createdAt?.toDate() || new Date();
                const updatedAt = item.updatedAt?.toDate() || createdAt;
                const timeInfo = `Upplagt: ${createdAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${createdAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}. Senast redigerad: ${updatedAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${updatedAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}`;

                calendarContainer.innerHTML += `
                    <div class="card flex items-start calendar-post" data-expanded="false" data-id="${item.id}" id="event-${item.id}">
                        <div class="flex-shrink-0 bg-blue-500 text-white font-bold p-4 rounded-lg text-center mr-4">
                            <p class="text-xl leading-none">${day}</p>
                            <p class="text-xs uppercase">${month}</p>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                            <p class="text-sm text-gray-500 mb-2">${timeInfo}</p>
                            <div class="text-gray-700 markdown-content calendar-post-short">${shortText}</div>
                            <div class="text-gray-700 markdown-content hidden calendar-post-expanded mt-2">${item.description}</div>
                            ${isAdminLoggedIn ? `<button class="delete-btn mt-4 px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="events" data-series-id="${item.seriesId || ''}">Ta bort</button>` : ''}
                        </div>
                    </div>
                `;
            });

            // Attach event listeners for calendar posts
            document.querySelectorAll('.calendar-post').forEach(post => {
                post.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-btn')) {
                        return;
                    }
                    const isExpanded = post.getAttribute('data-expanded') === 'true';
                    post.setAttribute('data-expanded', !isExpanded);
                    const shortText = post.querySelector('.calendar-post-short');
                    const expandedText = post.querySelector('.calendar-post-expanded');
                    if (isExpanded) {
                        shortText.classList.remove('hidden');
                        expandedText.classList.add('hidden');
                    } else {
                        shortText.classList.add('hidden');
                        expandedText.classList.remove('hidden');
                    }
                });
            });
        }

        // --- RENDER HISTORY POSTS ---
        function renderHistory() {
            const historyContainer = document.getElementById('home-history-container');
            if (!historyContainer) return;

            historyContainer.innerHTML = '';

            historyData.sort((a, b) => {
                const dateA = a.createdAt?.toDate() || new Date(a.date);
                const dateB = b.createdAt?.toDate() || new Date(b.date);
                return dateB - dateA;
            });
            
            historyData.forEach(item => {
                const date = item.createdAt?.toDate() || new Date(item.date);
                const createdAt = item.createdAt?.toDate() || new Date();
                const updatedAt = item.updatedAt?.toDate() || createdAt;
                const timeInfo = `Upplagt: ${createdAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${createdAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}. Senast redigerad: ${updatedAt.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' })} ${updatedAt.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' })}`;

                historyContainer.innerHTML += `
                    <div class="card" id="history-${item.id}">
                        <h3 class="text-2xl font-semibold mb-2">${item.title}</h3>
                        <p class="text-sm text-gray-500 mb-2">${timeInfo}</p>
                        <div class="text-gray-700 markdown-content">${item.content}</div>
                        <div class="flex items-center space-x-2 mt-4">
                            <button class="like-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-300 ${userHasLiked ? 'text-blue-500' : ''}" data-id="${item.id}" data-type="history" data-liked="${userHasLiked}">
                                👍 <span class="like-count">${likeCount}</span>
                            </button>
                            ${isAdminLoggedIn ? `
                                <button class="delete-btn px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="history">Ta bort</button>
                                <button class="edit-history-btn px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300" data-id="${item.id}">Ändra</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        }

        // --- RENDER IMAGES ---
        function renderImages() {
            const galleryContainer = document.getElementById('gallery-container');
            if (!galleryContainer) return;

            galleryContainer.innerHTML = '';
            
            // Sortera bilder efter år och månad
            imageData.sort((a, b) => {
                const dateA = new Date(a.year, a.month - 1);
                const dateB = new Date(b.year, b.month - 1);
                return dateB - dateA;
            });
            
            let currentYear = null;
            let currentMonth = null;

            imageData.forEach(item => {
                const itemDate = new Date(item.year, item.month - 1);
                const itemYear = itemDate.getFullYear();
                const itemMonth = itemDate.toLocaleString('sv-SE', { month: 'long' });

                if (itemYear !== currentYear || itemMonth !== currentMonth) {
                    currentYear = itemYear;
                    currentMonth = itemMonth;
                    galleryContainer.innerHTML += `
                        <h2 class="text-2xl font-bold mt-8 mb-4 col-span-full">${currentMonth} ${currentYear}</h2>
                        <hr class="col-span-full border-gray-300 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 col-span-full" id="image-group-${currentYear}-${item.month}"></div>
                    `;
                }

                const imageGroupContainer = document.getElementById(`image-group-${currentYear}-${item.month}`);

                if (imageGroupContainer) {
                    imageGroupContainer.innerHTML += `
                        <div class="relative group">
                            <img src="${item.url}" alt="${item.title}" class="gallery-image shadow-md group-hover:opacity-75 transition-opacity duration-300">
                            <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black via-black/50 to-transparent text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-b-lg">
                                <h3 class="text-lg font-bold">${item.title}</h3>
                            </div>
                            ${isAdminLoggedIn ? `
                                <div class="absolute top-2 right-2 flex space-x-2">
                                    <button class="edit-image-btn px-3 py-1 bg-gray-500 text-white text-xs font-bold rounded-full hover:bg-gray-600 transition duration-300" data-id="${item.id}">Ändra</button>
                                    <button class="delete-btn px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="images">Ta bort</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            });
        }

        function renderAdmins() {
            const admins = adminsData;
            const adminListEl = document.getElementById('admin-list');
            if (!adminListEl) return;
            
            adminListEl.innerHTML = '';
            admins.forEach(admin => {
                const adminEl = document.createElement('div');
                adminEl.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                adminEl.innerHTML = `
                    <span class="font-semibold">${admin.username}</span>
                    ${isAdminLoggedIn && admins.length > 1 && admin.username !== loggedInAdminUsername ? `<button class="delete-admin-btn text-red-500 hover:text-red-700 transition duration-300 text-sm" data-id="${admin.id}">Ta bort</button>` : ''}
                `;
                adminListEl.appendChild(adminEl);
            });
        }

        // --- EDITOR FUNCTIONS ---
        function applyEditorCommand(editor, command, value = null) {
            editor.focus();
            document.execCommand(command, false, value);
        }
        
        // Handle active/inactive buttons based on cursor position
        function updateToolbarButtons(editor) {
            const toolbar = editor.previousElementSibling;
            if (!toolbar) return;
            const boldButton = toolbar.querySelector('[data-command="bold"]');
            const italicButton = toolbar.querySelector('[data-command="italic"]');
            
            if (document.queryCommandState('bold')) {
                boldButton.classList.add('active');
            } else {
                boldButton.classList.remove('active');
            }
            
            if (document.queryCommandState('italic')) {
                italicButton.classList.add('active');
            } else {
                italicButton.classList.remove('active');
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => {
            const statusIndicator = document.createElement('div');
            statusIndicator.className = "p-2 rounded-lg text-white font-semibold text-center mb-4";
            document.getElementById('admin-panel').prepend(statusIndicator);
            
            if (firebaseConfigExists) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    statusIndicator.textContent = "Firebase är ansluten.";
                    statusIndicator.classList.add('bg-green-500');

                    await signInAnonymously(auth);

                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            currentUserId = user.uid;
                            console.log("Authenticated with Firebase:", currentUserId);
                            
                            // Initial rendering and live listeners
                            const newsRef = collection(db, `news`);
                            onSnapshot(newsRef, (snapshot) => {
                                newsData = [];
                                snapshot.forEach(doc => {
                                    newsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderNews();
                            });

                            const eventsRef = collection(db, `events`);
                            onSnapshot(eventsRef, (snapshot) => {
                                eventsData = [];
                                snapshot.forEach(doc => {
                                    eventsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderEvents();
                            });
                            
                            const adminsRef = collection(db, `admins`);
                            onSnapshot(adminsRef, (snapshot) => {
                                adminsData = [];
                                snapshot.forEach(doc => {
                                    adminsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderAdmins();
                            });

                            const historyRef = collection(db, `history`);
                            onSnapshot(historyRef, (snapshot) => {
                                historyData = [];
                                snapshot.forEach(doc => {
                                    historyData.push({ id: doc.id, ...doc.data() });
                                });
                                renderHistory();
                            });

                            const imageRef = collection(db, `images`);
                            onSnapshot(imageRef, (snapshot) => {
                                imageData = [];
                                snapshot.forEach(doc => {
                                    imageData.push({ id: doc.id, ...doc.data() });
                                });
                                renderImages();
                            });

                        } else {
                            console.log("Not authenticated with Firebase.");
                        }
                    });
                } catch (initError) {
                    console.error("Error initializing Firebase App:", initError);
                    statusIndicator.textContent = "Fel: Kunde inte ansluta till Firebase.";
                    statusIndicator.classList.remove('bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                }
            } else {
                statusIndicator.textContent = "Fel: Firebase-konfiguration saknas.";
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
            }

            // Function to handle liking a post
            async function handleLike(docId, collectionName) {
                if (!currentUserId) {
                    showModal('errorModal', "Du måste vara inloggad för att gilla poster.");
                    return;
                }
                const docRef = doc(db, collectionName, docId);
                const docSnap = await getDoc(docRef);
                const data = docSnap.data();
                const likes = data.likes || {};

                if (likes[currentUserId]) {
                    // Unlike
                    delete likes[currentUserId];
                } else {
                    // Like
                    likes[currentUserId] = true;
                }

                try {
                    await updateDoc(docRef, { likes: likes });
                } catch (error) {
                    console.error("Error updating likes:", error);
                    showModal('errorModal', "Ett fel uppstod när like-funktionen skulle uppdateras.");
                }
            }


            // Function to handle deletion of news/events/history
            async function deleteDocument(docId, collectionName) {
                if (!db || !isAdminLoggedIn) {
                    showModal('errorModal', "Du har inte behörighet att utföra denna åtgärd.");
                    return;
                }
                const docRef = doc(db, collectionName, docId);
                try {
                    await deleteDoc(docRef);
                    showModal('confirmationModal', `Posten har tagits bort från ${collectionName}.`);
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid borttagning av post:", error);
                    showModal('errorModal', "Ett fel uppstod när posten skulle tas bort. Kontrollera dina Firebase Security Rules.");
                }
            }
            
            // Function to handle deletion of admins
            async function deleteAdmin(adminId) {
                if (!db || !isAdminLoggedIn) {
                    showModal('errorModal', "Du har inte behörighet att utföra denna åtgärd.");
                    return;
                }
                if (adminsData.length <= 1) {
                    showModal('errorModal', "Kan inte ta bort den sista administratören.");
                    return;
                }
                const adminToDelete = adminsData.find(a => a.id === adminId);
                if (adminToDelete.username === loggedInAdminUsername) {
                    showModal('errorModal', "Du kan inte ta bort dig själv.");
                    return;
                }
                const adminRef = doc(db, 'admins', adminId);
                try {
                    await deleteDoc(adminRef);
                    showModal('confirmationModal', "Admin har tagits bort.");
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid borttagning av admin:", error);
                    showModal('errorModal', "Ett fel uppstod när admin skulle tas bort.");
                }
            }

            // Event delegation for "like" buttons
            document.addEventListener('click', (e) => {
                const likeBtn = e.target.closest('.like-btn');
                if (likeBtn) {
                    const docId = likeBtn.getAttribute('data-id');
                    const docType = likeBtn.getAttribute('data-type');
                    handleLike(docId, docType);
                }
            });

            // Event delegation for "delete" buttons (news, calendar, images)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const docType = e.target.getAttribute('data-type');
                    const seriesId = e.target.getAttribute('data-series-id');
                    
                    if (docType === 'events' && seriesId) {
                        // Show modal for deleting series
                        document.getElementById('delete-event-message').textContent = 'Denna händelse är en del av en serie. Vill du radera enbart denna händelse eller hela serien?';
                        document.getElementById('deleteEventModal').classList.add('active');
                        document.getElementById('delete-single-event-btn').onclick = () => {
                            deleteDocument(docId, docType);
                            hideModal('deleteEventModal');
                        };
                        document.getElementById('delete-series-event-btn').onclick = async () => {
                            // Delete the entire series
                            const batch = writeBatch(db);
                            const q = query(collection(db, 'events'), where('seriesId', '==', seriesId));
                            const querySnapshot = await getDocs(q);
                            querySnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            showModal('confirmationModal', "Hela serien har tagits bort.");
                            setTimeout(() => hideModal('confirmationModal'), 2000);
                            hideModal('deleteEventModal');
                        };
                        document.getElementById('cancel-event-delete-btn').onclick = () => hideModal('deleteEventModal');
                    } else {
                        // Show a general confirmation modal instead of confirm()
                        const postType = docType === 'news' ? 'nyhet' : (docType === 'events' ? 'händelse' : 'post');
                        document.getElementById('delete-confirmation-message').textContent = `Är du säker på att du vill ta bort denna ${postType}?`;
                        document.getElementById('deleteConfirmationModal').classList.add('active');
                        
                        document.getElementById('confirm-delete-btn').onclick = () => {
                            deleteDocument(docId, docType);
                            hideModal('deleteConfirmationModal');
                        };
                        document.getElementById('cancel-delete-btn').onclick = () => hideModal('deleteConfirmationModal');
                    }
                }
            });
            
            // Event delegation for "share" buttons
            document.addEventListener('click', (e) => {
                const shareBtn = e.target.closest('.share-btn');
                if (shareBtn) {
                    const newsId = shareBtn.getAttribute('data-id');
                    const newsTitle = shareBtn.getAttribute('data-title');
                    
                    const pageUrl = window.location.origin + window.location.pathname;
                    const shareUrl = `${pageUrl}#nyheter#news-${newsId}`;

                    document.getElementById('share-message-title').textContent = newsTitle;
                    document.getElementById('share-facebook-btn').href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;

                    const copyLinkBtn = document.getElementById('copy-link-btn');
                    copyLinkBtn.onclick = () => {
                        try {
                            const tempInput = document.createElement('input');
                            tempInput.value = shareUrl;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showModal('confirmationModal', "Länken har kopierats till urklipp!");
                            hideModal('shareModal');
                        } catch (err) {
                            showModal('errorModal', "Kunde inte kopiera länken.");
                        }
                    };

                    showModal('shareModal');
                }
            });

            // Event delegation for "edit" button for news
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-news-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const newsItem = newsData.find(item => item.id === docId);

                    if (newsItem) {
                        // Fill the form with existing data
                        document.getElementById('news-title').value = newsItem.title;
                        document.getElementById('news-content-editor').innerHTML = newsItem.content;
                        
                        const newsDate = newsItem.date || (newsItem.createdAt?.toDate() || new Date()).toISOString().split('T')[0];
                        document.getElementById('news-date').value = newsDate;

                        // Save the ID of the news being edited
                        editingNewsId = docId;
                        
                        // Change button text and navigate to admin page
                        const addNewsBtn = document.getElementById('add-news-btn');
                        addNewsBtn.textContent = 'Spara ändringar';
                        addNewsBtn.classList.remove('bg-gray-400');
                        addNewsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                        navigate('#admin');
                    }
                }
            });

            // Event delegation for "edit" button for history posts
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-history-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const historyItem = historyData.find(item => item.id === docId);

                    if (historyItem) {
                        historyFormTitle.textContent = 'Ändra Huvudsidpost';
                        document.getElementById('history-title').value = historyItem.title;
                        document.getElementById('history-content-editor').innerHTML = historyItem.content;
                        
                        editingHistoryId = docId;
                        
                        const addHistoryBtn = document.getElementById('add-history-btn');
                        addHistoryBtn.textContent = 'Spara ändringar';
                        addHistoryBtn.classList.remove('bg-gray-400');
                        addHistoryBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                        navigate('#admin');
                    }
                }
            });

            // Event delegation for "edit" button for images
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-image-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const imageItem = imageData.find(item => item.id === docId);

                    if (imageItem) {
                        document.getElementById('image-form-title').textContent = 'Ändra Bild';
                        document.getElementById('image-title').value = imageItem.title;
                        document.getElementById('image-url').value = imageItem.url;
                        document.getElementById('image-year').value = imageItem.year;
                        document.getElementById('image-month').value = imageItem.month;
                        
                        editingImageId = docId;
                        
                        const addImageBtn = document.getElementById('add-image-btn');
                        addImageBtn.textContent = 'Spara ändringar';
                        addImageBtn.classList.remove('bg-gray-400');
                        addImageBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                        navigate('#admin');
                    }
                }
            });

            // Event delegation for "Delete Admin" buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-admin-btn')) {
                    const adminId = e.target.getAttribute('data-id');
                    // Show a general confirmation modal instead of confirm()
                    document.getElementById('delete-confirmation-message').textContent = `Är du säker på att du vill ta bort denna administratör?`;
                    document.getElementById('deleteConfirmationModal').classList.add('active');
                    
                    document.getElementById('confirm-delete-btn').onclick = () => {
                        deleteAdmin(adminId);
                        hideModal('deleteConfirmationModal');
                    };
                    document.getElementById('cancel-delete-btn').onclick = () => hideModal('deleteConfirmationModal');
                }
            });
            
            // Handle clicks on editor buttons
            document.querySelectorAll('.editor-toolbar button').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const editor = document.getElementById(button.parentElement.dataset.editorTarget);
                    if (editor) {
                        editor.focus();
                        if (command === 'createLink') {
                            const url = prompt("Ange URL för länken:");
                            if (!url) return;
                            let linkText = prompt("Ange länktext (lämna tomt för att visa URL):");
                            if (!linkText) linkText = url;
                            
                            const protocol = url.startsWith('http') ? '' : 'https://';
                            document.execCommand('insertHTML', false, `<a href="${protocol}${url}" target="_blank">${linkText}</a>`);
                        } else if (command === 'insertImage') {
                            // Show the new modal for image insertion
                            showModal('insertImageModal', '');
                            const insertBtn = document.getElementById('insert-image-btn');
                            const cancelBtn = document.getElementById('cancel-image-btn');
                            const imageUrlInput = document.getElementById('image-url-input');
                            const imageSizeSelect = document.getElementById('image-size-select');

                            insertBtn.onclick = () => {
                                const imageUrl = imageUrlInput.value;
                                const imageSize = imageSizeSelect.value;
                                if (imageUrl) {
                                    let style = '';
                                    let maxWidth = '100%';
                                    if (imageSize === 'small') {
                                        maxWidth = '150px';
                                    } else if (imageSize === 'medium') {
                                        maxWidth = '400px';
                                    } else if (imageSize === 'large') {
                                        maxWidth = '800px';
                                    }
                                    style = `style="max-width: ${maxWidth}; height: auto;"`;
                                    
                                    document.execCommand('insertHTML', false, `<img src="${imageUrl}" alt="Bild" ${style}>`);
                                }
                                hideModal('insertImageModal');
                            };
                            cancelBtn.onclick = () => {
                                hideModal('insertImageModal');
                            };
                        } else {
                            document.execCommand(command, false);
                        }
                    }
                });
            });

            // Handle active/inactive buttons based on cursor position
            document.querySelectorAll('.editor-content').forEach(editor => {
                editor.addEventListener('mouseup', () => updateToolbarButtons(editor));
                editor.addEventListener('keyup', () => updateToolbarButtons(editor));
            });

            function updateToolbarButtons(editor) {
                const toolbar = editor.previousElementSibling;
                if (!toolbar) return;
                const boldButton = toolbar.querySelector('[data-command="bold"]');
                const italicButton = toolbar.querySelector('[data-command="italic"]');
                
                if (document.queryCommandState('bold')) {
                    boldButton.classList.add('active');
                } else {
                    boldButton.classList.remove('active');
                }
                
                if (document.queryCommandState('italic')) {
                    italicButton.classList.add('active');
                } else {
                    italicButton.classList.remove('active');
                }
            }

            // Function to navigate and update admin status
            function navigate(hash) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.querySelector(hash);
                if (targetPage) {
                    targetPage.classList.add('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    document.getElementById('hem').classList.add('active');
                }
            }

            // --- MODAL EVENT LISTENERS ---
            const errorModal = document.getElementById('errorModal');
            const closeErrorModalBtn = document.getElementById('close-error-modal');
            if (closeErrorModalBtn) {
                closeErrorModalBtn.addEventListener('click', () => {
                    hideModal('errorModal');
                });
            }
            if (errorModal) {
                errorModal.addEventListener('click', (event) => {
                    if (event.target === errorModal) {
                        hideModal('errorModal');
                    }
                });
            }

            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.addEventListener('click', (event) => {
                    if (event.target === confirmationModal) {
                        hideModal('confirmationModal');
                    }
                });
            }
            
            const shareModal = document.getElementById('shareModal');
            if (shareModal) {
                shareModal.addEventListener('click', (event) => {
                    if (event.target === shareModal || event.target.closest('#close-share-modal')) {
                        hideModal('shareModal');
                    }
                });
            }


            // Event delegation for news and calendar on home page
            document.addEventListener('click', (e) => {
                const calendarPost = e.target.closest('.home-calendar-post');
                if (calendarPost) {
                    const id = calendarPost.getAttribute('data-id');
                    navigate('#kalender');
                    setTimeout(() => {
                        const targetEvent = document.getElementById(`event-${id}`);
                        if (targetEvent) {
                            targetEvent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            if (targetEvent.getAttribute('data-expanded') === 'false') {
                                targetEvent.click();
                            }
                        }
                    }, 100);
                }
                const newsPost = e.target.closest('.home-news-post');
                if (newsPost) {
                    const id = newsPost.getAttribute('data-id');
                    navigate('#nyheter');
                    setTimeout(() => {
                        const targetNews = document.getElementById(`news-${id}`);
                        if (targetNews) {
                            targetNews.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                }
            });
            
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const hash = e.target.getAttribute('href');
                    history.pushState(null, '', hash);
                    navigate(hash);
                });
            });

            window.addEventListener('popstate', () => {
                navigate(window.location.hash || '#hem');
            });
            
            navigate(window.location.hash || '#hem');

            // --- ADMIN PANEL LOGIC ---
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminUsernameInput = document.getElementById('admin-username');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminLoginPanel = document.getElementById('admin-login-panel');
            const adminPanel = document.getElementById('admin-panel');
            const adminUserInfo = document.getElementById('admin-user-info');
            const addAdminForm = document.getElementById('add-admin-form');
            const newAdminUsernameInput = document.getElementById('new-admin-username');
            const newAdminPasswordInput = document.getElementById('new-admin-password');
            
            // News form
            const newsFormTitle = document.getElementById('news-form-title');
            const newsTitleInput = document.getElementById('news-title');
            const newsDateInput = document.getElementById('news-date');
            const newsContentEditor = document.getElementById('news-content-editor');
            const newsAddBtn = document.getElementById('add-news-btn');

            // History form
            const historyFormTitle = document.getElementById('history-form-title');
            const historyTitleInput = document.getElementById('history-title');
            const historyContentEditor = document.getElementById('history-content-editor');
            const historyAddBtn = document.getElementById('add-history-btn');

            // Image form
            const imageFormTitle = document.getElementById('image-form-title');
            const imageTitleInput = document.getElementById('image-title');
            const imageUrlInput = document.getElementById('image-url');
            const imageYearInput = document.getElementById('image-year');
            const imageMonthSelect = document.getElementById('image-month');
            const addImageBtn = document.getElementById('add-image-btn');

            const eventAddBtn = document.getElementById('add-event-btn');
            const eventDescriptionEditor = document.getElementById('event-description-editor');

            // Toggle for recurring events
            const isRecurringCheckbox = document.getElementById('is-recurring');
            const singleEventFields = document.getElementById('single-event-fields');
            const recurringEventFields = document.getElementById('recurring-event-fields');
            isRecurringCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    singleEventFields.classList.add('hidden');
                    recurringEventFields.classList.remove('hidden');
                    document.getElementById('event-date').removeAttribute('required');
                    document.getElementById('start-date').setAttribute('required', 'required');
                    document.getElementById('end-date').setAttribute('required', 'required');
                } else {
                    singleEventFields.classList.remove('hidden');
                    recurringEventFields.classList.add('hidden');
                    document.getElementById('event-date').setAttribute('required', 'required');
                    document.getElementById('start-date').removeAttribute('required');
                    document.getElementById('end-date').removeAttribute('required');
                }
            });

            loginBtn.addEventListener('click', async () => {
                const username = adminUsernameInput.value;
                const password = adminPasswordInput.value;
                let foundAdmin = false;
                let adminToLog = {};

                // Handle the hardcoded admin user
                if (username === 'admin' && password === 'admin') {
                    foundAdmin = true;
                    adminToLog = { username: 'admin' };
                    // Add the hardcoded admin to the database if it doesn't exist
                    try {
                        const adminsRef = collection(db, 'admins');
                        const q = query(adminsRef, where('username', '==', 'admin'));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) {
                            await addDoc(adminsRef, { username: 'admin', password: 'admin' });
                            console.log('Hardcoded admin created in the database.');
                        }
                    } catch (error) {
                        console.error('Error handling hardcoded admin:', error);
                    }
                } else {
                    // Search for admin in the database
                    try {
                        const adminsRef = collection(db, 'admins');
                        const q = query(adminsRef, where('username', '==', username), where('password', '==', password));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            foundAdmin = true;
                            querySnapshot.forEach(doc => {
                                adminToLog = { ...doc.data() };
                            });
                        }
                    } catch (error) {
                        console.error('Error searching for admin:', error);
                    }
                }

                if (foundAdmin) {
                    isAdminLoggedIn = true;
                    loggedInAdminUsername = adminToLog.username;
                    adminLoginPanel.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    if (auth && auth.currentUser) {
                        adminUserInfo.textContent = `Du är inloggad som administratör (Användar-ID: ${auth.currentUser.uid}, Admin: ${loggedInAdminUsername})`;
                    }
                    newsAddBtn.disabled = false;
                    newsAddBtn.classList.remove('bg-gray-400');
                    newsAddBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    eventAddBtn.disabled = false;
                    eventAddBtn.classList.remove('bg-gray-400');
                    eventAddBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    historyAddBtn.disabled = false;
                    historyAddBtn.classList.remove('bg-gray-400');
                    historyAddBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    addImageBtn.disabled = false;
                    addImageBtn.classList.remove('bg-gray-400');
                    addImageBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    
                    // Manually update UI after login to show delete buttons
                    renderNews();
                    renderEvents();
                    renderHistory();
                    renderImages();
                    renderAdmins();
                } else {
                    showModal('errorModal', 'Felaktigt användarnamn eller lösenord!');
                }
            });

            logoutBtn.addEventListener('click', () => {
                isAdminLoggedIn = false;
                loggedInAdminUsername = '';
                adminLoginPanel.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                adminUsernameInput.value = '';
                adminPasswordInput.value = '';
                newsAddBtn.disabled = true;
                newsAddBtn.classList.add('bg-gray-400');
                newsAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                eventAddBtn.disabled = true;
                eventAddBtn.classList.add('bg-gray-400');
                eventAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                historyAddBtn.disabled = true;
                historyAddBtn.classList.add('bg-gray-400');
                historyAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                addImageBtn.disabled = true;
                addImageBtn.classList.add('bg-gray-400');
                addImageBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');

                // Återställ formulär-titlar till standard
                historyFormTitle.textContent = 'Lägg till Huvudsidposter';
                imageFormTitle.textContent = 'Lägg till Bild';

                renderNews();
                renderEvents();
                renderHistory();
                renderImages();
                renderAdmins();
                navigate('#hem');
            });


            addAdminForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten.");
                    return;
                }
                const newAdmin = {
                    username: newAdminUsernameInput.value,
                    password: newAdminPasswordInput.value
                };
                
                try {
                    await addDoc(collection(db, `admins`), newAdmin);
                    addAdminForm.reset();
                    showModal('confirmationModal', "Ny admin har lagts till!");
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid tillägg av admin:", error);
                    showModal('errorModal', "Ett fel uppstod när admin skulle läggas till.");
                }
            });


            // --- FORMS TO ADD DATA TO FIREBASE ---
            const addNewsForm = document.getElementById('add-news-form');
            addNewsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                
                const newsTitle = newsTitleInput.value;
                const newsContent = newsContentEditor.innerHTML;
                const newsDate = newsDateInput.value;
                
                const newsObject = {
                    title: newsTitle,
                    content: newsContent,
                    date: newsDate,
                    createdAt: editingNewsId ? newsData.find(n => n.id === editingNewsId).createdAt : serverTimestamp(),
                    updatedAt: editingNewsId ? serverTimestamp() : null
                };

                try {
                    if (editingNewsId) {
                        // Update existing news
                        await updateDoc(doc(db, 'news', editingNewsId), newsObject);
                        console.log("Nyhet uppdaterad!");
                        showModal('confirmationModal', "Nyhet har uppdaterats!");
                    } else {
                        // Add new news
                        await addDoc(collection(db, `news`), newsObject);
                        console.log("Nyhet tillagd!");
                        showModal('confirmationModal', "Nyhet har lagts till!");
                    }
                    
                    // Reset form and variables
                    addNewsForm.reset();
                    newsContentEditor.innerHTML = '';
                    newsDateInput.value = new Date().toISOString().split('T')[0];
                    editingNewsId = null;
                    newsFormTitle.textContent = 'Lägg till Nyhet';
                    newsAddBtn.textContent = 'Lägg till';
                    newsAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    newsAddBtn.classList.add('bg-gray-400');
                    
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid hantering av nyhet:", error);
                    showModal('errorModal', "Ett fel uppstod. Kontrollera dina Firebase Security Rules.");
                }
            });

            const addHistoryForm = document.getElementById('add-history-form');
            addHistoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                const historyTitle = historyTitleInput.value;
                const historyContent = historyContentEditor.innerHTML;

                const historyObject = {
                    title: historyTitle,
                    content: historyContent,
                    createdAt: editingHistoryId ? historyData.find(h => h.id === editingHistoryId).createdAt : serverTimestamp(),
                    updatedAt: editingHistoryId ? serverTimestamp() : null
                };

                try {
                    if (editingHistoryId) {
                        await updateDoc(doc(db, 'history', editingHistoryId), historyObject);
                        console.log("Historiepost uppdaterad!");
                        showModal('confirmationModal', "Huvudsidpost har uppdaterats!");
                    } else {
                        await addDoc(collection(db, 'history'), historyObject);
                        console.log("Historiepost tillagd!");
                        showModal('confirmationModal', "Huvudsidpost har lagts till!");
                    }

                    addHistoryForm.reset();
                    historyContentEditor.innerHTML = '';
                    editingHistoryId = null;
                    historyFormTitle.textContent = 'Lägg till Huvudsidposter';
                    historyAddBtn.textContent = 'Lägg till';
                    historyAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    historyAddBtn.classList.add('bg-gray-400');

                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid hantering av historiepost:", error);
                    showModal('errorModal', "Ett fel uppstod. Kontrollera dina Firebase Security Rules.");
                }
            });

            const addImageForm = document.getElementById('add-image-form');
            addImageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                
                const imageTitle = imageTitleInput.value;
                const imageUrl = imageUrlInput.value;
                const imageYear = parseInt(imageYearInput.value);
                const imageMonth = parseInt(imageMonthSelect.value);
                
                const imageObject = {
                    title: imageTitle,
                    url: imageUrl,
                    year: imageYear,
                    month: imageMonth,
                    createdAt: editingImageId ? imageData.find(i => i.id === editingImageId).createdAt : serverTimestamp(),
                    updatedAt: editingImageId ? serverTimestamp() : null
                };

                try {
                    if (editingImageId) {
                        await updateDoc(doc(db, 'images', editingImageId), imageObject);
                        console.log("Bild uppdaterad!");
                        showModal('confirmationModal', "Bilden har uppdaterats!");
                    } else {
                        await addDoc(collection(db, 'images'), imageObject);
                        console.log("Bild tillagd!");
                        showModal('confirmationModal', "Bilden har lagts till!");
                    }

                    addImageForm.reset();
                    editingImageId = null;
                    imageFormTitle.textContent = 'Lägg till Bild';
                    addImageBtn.textContent = 'Lägg till Bild';
                    addImageBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    addImageBtn.classList.add('bg-gray-400');
                    
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid hantering av bild:", error);
                    showModal('errorModal', "Ett fel uppstod när bilden skulle hanteras. Kontrollera dina Firebase Security Rules.");
                }
            });


            const addEventForm = document.getElementById('add-event-form');
            addEventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                
                const newEvent = {
                    title: document.getElementById('event-title').value,
                    description: document.getElementById('event-description-editor').innerHTML,
                    createdAt: editingNewsId ? newsData.find(n => n.id === editingNewsId).createdAt : serverTimestamp(),
                    updatedAt: editingNewsId ? serverTimestamp() : null
                };

                const isRecurring = document.getElementById('is-recurring').checked;
                const eventsCollection = collection(db, `events`);

                if (isRecurring) {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;
                    const weekday = parseInt(document.getElementById('weekday-select').value, 10);
                    
                    if (!startDate || !endDate) {
                        showModal('errorModal', "Start- och slutdatum måste anges för återkommande händelser.");
                        return;
                    }

                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const seriesId = `series-${Date.now()}`;
                    const batch = writeBatch(db);
                    
                    for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() === weekday) {
                            const newDate = d.toISOString().split('T')[0];
                            const eventRef = doc(eventsCollection);
                            batch.set(eventRef, { ...newEvent, date: newDate, seriesId: seriesId });
                        }
                    }
                    
                    try {
                        await batch.commit();
                        console.log("Återkommande händelser tillagda!");
                        addEventForm.reset();
                        document.getElementById('event-description-editor').innerHTML = '';
                        showModal('confirmationModal', "Återkommande händelser har lagts till!");
                        setTimeout(() => hideModal('confirmationModal'), 2000);
                    } catch (error) {
                        console.error("Fel vid tillägg av händelse:", error);
                        showModal('errorModal', "Ett fel uppstod när händelsen skulle läggas till. Kontrollera dina Firebase Security Rules.");
                    }
                } else {
                    const eventDate = document.getElementById('event-date').value;
                    if (!eventDate) {
                        showModal('errorModal', "Datum måste anges för enskild händelse.");
                        return;
                    }

                    try {
                        await addDoc(eventsCollection, { ...newEvent, date: eventDate });
                        console.log("Händelse tillagd!");
                        addEventForm.reset();
                        document.getElementById('event-description-editor').innerHTML = '';
                        showModal('confirmationModal', "Händelse har lagts till!");
                        setTimeout(() => hideModal('confirmationModal'), 2000);
                    } catch (error) {
                        console.error("Fel vid tillägg av händelse:", error);
                        showModal('errorModal', "Ett fel uppstod när händelsen skulle läggas till. Kontrollera dina Firebase Security Rules.");
                    }
                }
            });
        });
    </script>
</body>
</html>

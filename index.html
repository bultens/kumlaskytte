<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klubbens Webbplats</title>
    <!-- Använd Tailwind CSS för en snygg och responsiv design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        /* Modal-styling för felmeddelanden och bekräftelse */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 0.75rem;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .modal-close-btn {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style för den enkla redigeraren */
        .editor-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap; /* Gör att knapparna kan radbrytas på små skärmar */
        }
        .editor-toolbar button {
            transition: background-color 0.2s;
        }
        .editor-toolbar .active {
            background-color: #cbd5e1; /* Tailwind 'slate-300' för aktiv knapp */
        }
        .editor-content {
            min-height: 150px;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            outline: none;
        }
        /* Stilar för Markdown-innehåll */
        .markdown-content p {
            margin-bottom: 1rem;
        }
        .markdown-content a {
            color: #2563eb;
            text-decoration: underline;
        }
        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        /* Kalenderpost-styling för klickbarhet */
        .calendar-post {
            cursor: pointer;
        }
        .calendar-post-expanded {
            display: block;
        }
    </style>
</head>
<body>

    <!-- Header och navigering -->
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container py-4 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <a href="#" class="text-3xl font-bold tracking-tight">Kumla Skytte Förening</a>
                <p class="text-sm text-gray-300 mt-1">Ver. 1.19</p>
            </div>
            <nav>
                <ul class="flex space-x-4 font-medium">
                    <li><a href="#hem" class="hover:text-gray-300 transition duration-300">Hem</a></li>
                    <li><a href="#nyheter" class="hover:text-gray-300 transition duration-300">Nyheter</a></li>
                    <li><a href="#kalender" class="hover:text-gray-300 transition duration-300">Kalender</a></li>
                    <li><a href="#admin" class="hover:text-gray-300 transition duration-300">Admin</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Huvudinnehåll -->
    <main class="container">

        <!-- Sida: Hem -->
        <section id="hem" class="page active">
            <div class="bg-blue-100 p-8 rounded-xl text-center mb-8">
                <h1 class="text-4xl font-extrabold text-blue-900 mb-4">Välkommen till Kumla Skytte Förening!</h1>
                <p class="text-lg text-blue-700">Vi är en klubb för entusiaster av skytte. Här kan du hitta information om vår historia, nyheter och kommande evenemang.</p>
            </div>
            
            <h2 class="text-3xl font-bold mb-4">Senaste Nyheterna</h2>
            <div id="home-news-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nyheter kommer att renderas här av JavaScript -->
            </div>
            
            <h2 class="text-3xl font-bold mt-8 mb-4">Kommande Evenemang</h2>
            <div id="home-events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Kalenderhändelser kommer att renderas här av JavaScript -->
            </div>

            <div class="mt-8 card">
                <h2 class="text-3xl font-bold mb-4">Klubbens Historia</h2>
                <p class="text-gray-700 leading-relaxed">
                    Klubbens historia sträcker sig tillbaka till 1904. Grundad av en passionerad grupp av skyttar, har vi vuxit till en samlingspunkt för likasinnade. Genom åren har vi arrangerat otaliga evenemang och byggt en stark gemenskap. Vårt mål är att fortsätta främja sporten.
                </p>
            </div>
        </section>

        <!-- Sida: Nyheter -->
        <section id="nyheter" class="page">
            <h1 class="text-4xl font-bold mb-6">Alla Nyheter</h1>
            <div id="all-news-container" class="space-y-6">
                <!-- Nyheter kommer att renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Kalender -->
        <section id="kalender" class="page">
            <h1 class="text-4xl font-bold mb-6">Kalender</h1>
            <div id="calendar-container" class="space-y-6">
                <!-- Kalenderhändelser kommer att renderas här av JavaScript -->
            </div>
        </section>

        <!-- Sida: Admin -->
        <section id="admin" class="page">
            <div id="admin-login-panel" class="card max-w-md mx-auto">
                <h1 class="text-2xl font-bold mb-4">Admininloggning</h1>
                <input type="text" id="admin-username" placeholder="Användarnamn" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <input type="password" id="admin-password" placeholder="Lösenord" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Logga in</button>
            </div>

            <div id="admin-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-4xl font-bold">Administrationspanel</h1>
                    <button id="logout-btn" class="px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300">Logga ut</button>
                </div>
                <div id="admin-user-info" class="mb-4 text-sm text-gray-500"></div>
                
                <!-- Adminhantering -->
                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4">Adminhantering</h2>
                    <form id="add-admin-form">
                        <label for="new-admin-username" class="block mb-2 font-semibold">Nytt Admin-användarnamn</label>
                        <input type="text" id="new-admin-username" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        <label for="new-admin-password" class="block mb-2 font-semibold">Nytt Admin-lösenord</label>
                        <input type="password" id="new-admin-password" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        <button type="submit" id="add-admin-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">Lägg till Admin</button>
                    </form>
                    
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-2">Befintliga administratörer</h3>
                        <div id="admin-list" class="space-y-2">
                            <!-- Administratörer renderas här -->
                        </div>
                    </div>
                </div>

                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4">Lägg till Nyhet</h2>
                    <form id="add-news-form">
                        <label for="news-title" class="block mb-2 font-semibold">Titel</label>
                        <input type="text" id="news-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <label for="news-content" class="block mb-2 font-semibold">Innehåll</label>
                        <div class="editor-toolbar" data-editor-target="news-content-editor">
                            <button type="button" data-command="bold" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 font-bold">B</button>
                            <button type="button" data-command="italic" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 italic">I</button>
                            <button type="button" data-command="createLink" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Länk</button>
                            <button type="button" data-command="insertImage" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Bild</button>
                        </div>
                        <div id="news-content-editor" contenteditable="true" class="editor-content w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></div>
                        <input type="hidden" id="news-content-hidden">
                        
                        <button type="submit" id="add-news-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till</button>
                    </form>
                </div>

                <div class="card mt-6">
                    <h2 class="text-2xl font-bold mb-4">Lägg till Kalenderhändelse</h2>
                    <form id="add-event-form">
                        <label for="event-title" class="block mb-2 font-semibold">Titel</label>
                        <input type="text" id="event-title" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        
                        <!-- Välj om händelsen är återkommande eller inte -->
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="is-recurring" class="mr-2">
                            <label for="is-recurring" class="font-semibold">Återkommande händelse</label>
                        </div>

                        <!-- Fält för engångshändelse -->
                        <div id="single-event-fields">
                            <label for="event-date" class="block mb-2 font-semibold">Datum</label>
                            <input type="date" id="event-date" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                        </div>

                        <!-- Fält för återkommande händelse -->
                        <div id="recurring-event-fields" class="hidden">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="start-date" class="block mb-2 font-semibold">Startdatum</label>
                                    <input type="date" id="start-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="end-date" class="block mb-2 font-semibold">Slutdatum</label>
                                    <input type="date" id="end-date" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <label class="block mb-2 font-semibold">Veckodag</label>
                            <select id="weekday-select" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                                <option value="1">Måndag</option>
                                <option value="2">Tisdag</option>
                                <option value="3">Onsdag</option>
                                <option value="4">Torsdag</option>
                                <option value="5">Fredag</option>
                                <option value="6">Lördag</option>
                                <option value="0">Söndag</option>
                            </select>
                        </div>

                        <label for="event-description" class="block mb-2 font-semibold">Beskrivning</label>
                        <div class="editor-toolbar" data-editor-target="event-description-editor">
                            <button type="button" data-command="bold" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 font-bold">B</button>
                            <button type="button" data-command="italic" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 italic">I</button>
                            <button type="button" data-command="createLink" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Länk</button>
                            <button type="button" data-command="insertImage" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">Bild</button>
                        </div>
                        <div id="event-description-editor" contenteditable="true" class="editor-content w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"></div>
                        <input type="hidden" id="event-description-hidden">

                        <button type="submit" id="add-event-btn" disabled class="bg-gray-400 text-white font-bold py-3 px-4 rounded-lg">Lägg till</button>
                    </form>
                </div>
            </div>
        </section>
        
        <!-- Modal för felmeddelanden -->
        <div id="errorModal" class="modal">
            <div class="modal-content">
                <span id="close-error-modal" class="modal-close-btn">&times;</span>
                <p id="error-message" class="text-lg font-semibold text-red-600"></p>
            </div>
        </div>

        <!-- Bekräftelse-modal -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <p id="confirmation-message" class="text-lg font-semibold text-green-600"></p>
            </div>
        </div>
        
        <!-- Raderingsmodal för kalenderhändelser och nyheter -->
        <div id="deleteConfirmationModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Bekräfta borttagning</h3>
                <p id="delete-confirmation-message" class="mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Ja</button>
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

        <!-- Raderingsmodal för kalenderhändelser -->
        <div id="deleteEventModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Radera händelse</h3>
                <p id="delete-event-message" class="mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="delete-single-event-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Radera enskild händelse</button>
                    <button id="delete-series-event-btn" class="px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Radera hel serie</button>
                    <button id="cancel-event-delete-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

        <!-- Modal för att lägga till bild -->
        <div id="insertImageModal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Infoga bild</h3>
                <label for="image-url-input" class="block mb-2 font-semibold">Bild-URL</label>
                <input type="url" id="image-url-input" placeholder="https://exempel.se/bild.jpg" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                
                <label for="image-size-select" class="block mb-2 font-semibold">Storlek</label>
                <select id="image-size-select" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
                    <option value="small">Liten (150px)</option>
                    <option value="medium" selected>Medium (400px)</option>
                    <option value="large">Stor (800px)</option>
                    <option value="original">Originalstorlek</option>
                </select>

                <div class="flex justify-center space-x-4">
                    <button id="insert-image-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Infoga</button>
                    <button id="cancel-image-btn" class="px-4 py-2 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500">Avbryt</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-blue-800 text-white text-center py-4 mt-8">
        <div class="container text-sm">
            <p class="font-bold">Kumla Skytte Förening</p>
            <p>Adress: Viagatan 5, Kumla, Sweden</p>
            <p>Telefon: 073-088 57 25</p>
            <p>Grundad: 1904</p>
        </div>
    </footer>
    
    <!-- Firebase SDK-skript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc, query, where, getDocs, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCorCZf8cH8vD1v47aOADdW3x0hCWlVUfw",
            authDomain: "kumlaskytte.firebaseapp.com",
            projectId: "kumlaskytte",
            storageBucket: "kumlaskytte.firebasestorage.app",
            messagingSenderId: "571676149705",
            appId: "1:571676149705:web:a0ace868f4680298a78a18",
            measurementId: "G-KSJ9NLNDBX"
        };

        const firebaseConfigExists = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey.length > 0;
        let db;
        let auth;
        let isAdminLoggedIn = false;
        let loggedInAdminUsername = '';
        let newsData = [];
        let eventsData = [];
        let adminsData = [];
        let editingNewsId = null; // Håll koll på vilken nyhet som redigeras

        // --- MODAL-FUNKTIONER ---
        function showModal(modalId, message) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const messageEl = modal.querySelector('p');
            if (messageEl) {
                messageEl.innerHTML = message; // Använd innerHTML för att tillåta HTML-taggar
            }
            modal.classList.add('active');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            modal.classList.remove('active');
        }

        // Funktion för att extrahera den första textraden från HTML-innehåll
        function getFirstLineText(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            // Hämta första textnoden eller första paragrafens text
            const firstChild = tempDiv.firstElementChild;
            if (firstChild && firstChild.tagName === 'P') {
                return firstChild.textContent;
            }
            return tempDiv.textContent.split('\n')[0].trim();
        }

        // Funktion för att extrahera den första bilden från HTML-innehåll
        function getFirstImage(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const firstImage = tempDiv.querySelector('img');
            return firstImage ? firstImage.outerHTML : '';
        }

        // --- RENDERING AV INNEHÅLL ---
        function renderNews() {
            const news = newsData;
            const homeNewsContainer = document.getElementById('home-news-container');
            const allNewsContainer = document.getElementById('all-news-container');

            if (!homeNewsContainer || !allNewsContainer) return;

            homeNewsContainer.innerHTML = '';
            allNewsContainer.innerHTML = '';

            news.sort((a, b) => {
                const dateA = a.createdAt?.toDate() || new Date(a.date);
                const dateB = b.createdAt?.toDate() || new Date(b.date);
                return dateB - dateA;
            });
            
            // Visa de 2 senaste nyheterna på startsidan
            news.slice(0, 2).forEach(item => {
                const date = item.createdAt?.toDate() || new Date(item.date);
                const formattedDate = date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' });
                const firstLine = getFirstLineText(item.content);
                const firstImage = getFirstImage(item.content);
                
                let imageHtml = '';
                if (firstImage) {
                    const tempImgDiv = document.createElement('div');
                    tempImgDiv.innerHTML = firstImage;
                    const img = tempImgDiv.querySelector('img');
                    // Ändra storleken på bilden till en liten miniatyr för startsidan
                    img.setAttribute('style', 'width: 150px; height: auto;');
                    img.classList.add('rounded-lg', 'object-cover', 'mr-4');
                    imageHtml = `<div class="flex-shrink-0">${img.outerHTML}</div>`;
                }

                homeNewsContainer.innerHTML += `
                    <div class="card flex items-start news-post home-news-post cursor-pointer" data-id="${item.id}">
                        ${imageHtml}
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                            <p class="text-sm text-gray-500 mb-2">Publicerad: ${formattedDate}</p>
                            <div class="text-gray-700 markdown-content">${firstLine}</div>
                        </div>
                    </div>
                `;
            });

            // Visa alla nyheter på nyhetssidan
            news.forEach(item => {
                const date = item.createdAt?.toDate() || new Date(item.date);
                const formattedDate = date.toLocaleDateString('sv-SE', { day: 'numeric', month: 'long', year: 'numeric' });
                allNewsContainer.innerHTML += `
                    <div class="card" id="news-${item.id}">
                        <h3 class="text-2xl font-semibold mb-2">${item.title}</h3>
                        <p class="text-sm text-gray-500 mb-2">Publicerad: ${formattedDate}</p>
                        <div class="text-gray-700 markdown-content">${item.content}</div>
                        ${isAdminLoggedIn ? `
                            <div class="flex space-x-2 mt-4">
                                <button class="delete-btn px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="news">Ta bort</button>
                                <button class="edit-news-btn px-4 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-300" data-id="${item.id}">Ändra</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        }
        
        function renderEvents() {
            const events = eventsData;
            const calendarContainer = document.getElementById('calendar-container');
            const homeEventsContainer = document.getElementById('home-events-container');

            if (!calendarContainer || !homeEventsContainer) return;

            calendarContainer.innerHTML = '';
            homeEventsContainer.innerHTML = '';
            
            // Sortera händelser efter datum och filtrera bort gamla händelser
            const today = new Date().toISOString().split('T')[0];
            const upcomingEvents = events.filter(e => e.date >= today);
            
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date)); 

            // Visa de 2 nästkommande händelserna på startsidan
            upcomingEvents.slice(0, 2).forEach(item => {
                const eventDate = new Date(item.date);
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('sv-SE', { month: 'short' });
                
                homeEventsContainer.innerHTML += `
                    <div class="card flex items-start calendar-post home-calendar-post" data-id="${item.id}">
                        <div class="flex-shrink-0 bg-blue-500 text-white font-bold p-4 rounded-lg text-center mr-4">
                            <p class="text-xl leading-none">${day}</p>
                            <p class="text-xs uppercase">${month}</p>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                        </div>
                    </div>
                `;
            });


            upcomingEvents.forEach(item => {
                const eventDate = new Date(item.date);
                const day = eventDate.getDate();
                const month = eventDate.toLocaleString('sv-SE', { month: 'short' });
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = item.description;
                const shortText = tempDiv.firstElementChild && tempDiv.firstElementChild.tagName === 'P' ? tempDiv.firstElementChild.innerHTML : tempDiv.innerHTML;
                
                calendarContainer.innerHTML += `
                    <div class="card flex items-start calendar-post" data-expanded="false" data-id="${item.id}" id="event-${item.id}">
                        <div class="flex-shrink-0 bg-blue-500 text-white font-bold p-4 rounded-lg text-center mr-4">
                            <p class="text-xl leading-none">${day}</p>
                            <p class="text-xs uppercase">${month}</p>
                        </div>
                        <div class="flex-grow">
                            <h3 class="text-2xl font-semibold mb-1">${item.title}</h3>
                            <p class="text-sm text-gray-500 mb-2">${item.date}</p>
                            <div class="text-gray-700 markdown-content calendar-post-short">${shortText}</div>
                            <div class="text-gray-700 markdown-content hidden calendar-post-expanded mt-2">${item.description}</div>
                            ${isAdminLoggedIn ? `<button class="delete-btn mt-4 px-4 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300" data-id="${item.id}" data-type="events" data-series-id="${item.seriesId || ''}">Ta bort</button>` : ''}
                        </div>
                    </div>
                `;
            });

            // Fäster event-lyssnare för kalenderposterna
            document.querySelectorAll('.calendar-post').forEach(post => {
                post.addEventListener('click', (e) => {
                    // Förhindra att klick på "Ta bort"-knappen utlöser expansionen
                    if (e.target.classList.contains('delete-btn')) {
                        return;
                    }
                    const isExpanded = post.getAttribute('data-expanded') === 'true';
                    post.setAttribute('data-expanded', !isExpanded);
                    const shortText = post.querySelector('.calendar-post-short');
                    const expandedText = post.querySelector('.calendar-post-expanded');
                    if (isExpanded) {
                        shortText.classList.remove('hidden');
                        expandedText.classList.add('hidden');
                    } else {
                        shortText.classList.add('hidden');
                        expandedText.classList.remove('hidden');
                    }
                });
            });
        }

        function renderAdmins() {
            const admins = adminsData;
            const adminListEl = document.getElementById('admin-list');
            if (!adminListEl) return;
            
            adminListEl.innerHTML = '';
            admins.forEach(admin => {
                const adminEl = document.createElement('div');
                adminEl.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                adminEl.innerHTML = `
                    <span class="font-semibold">${admin.username}</span>
                    ${isAdminLoggedIn && admins.length > 1 && admin.username !== loggedInAdminUsername ? `<button class="delete-admin-btn text-red-500 hover:text-red-700 transition duration-300 text-sm" data-id="${admin.id}">Ta bort</button>` : ''}
                `;
                adminListEl.appendChild(adminEl);
            });
        }

        // --- EDITOR-FUNKTIONER ---
        function applyEditorCommand(editor, command, value = null) {
            editor.focus();
            document.execCommand(command, false, value);
        }
        
        // Hantera att knappar blir aktiva/inaktiva baserat på markören
        function updateToolbarButtons(editor) {
            const toolbar = editor.previousElementSibling;
            if (!toolbar) return;
            const boldButton = toolbar.querySelector('[data-command="bold"]');
            const italicButton = toolbar.querySelector('[data-command="italic"]');
            
            if (document.queryCommandState('bold')) {
                boldButton.classList.add('active');
            } else {
                boldButton.classList.remove('active');
            }
            
            if (document.queryCommandState('italic')) {
                italicButton.classList.add('active');
            } else {
                italicButton.classList.remove('active');
            }
        }

        // --- EVENT-LYSSNARE ---
        document.addEventListener('DOMContentLoaded', async () => {
            const statusIndicator = document.createElement('div');
            statusIndicator.className = "p-2 rounded-lg text-white font-semibold text-center mb-4";
            document.getElementById('admin-panel').prepend(statusIndicator);
            
            if (firebaseConfigExists) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    statusIndicator.textContent = "Firebase är ansluten.";
                    statusIndicator.classList.add('bg-green-500');

                    await signInAnonymously(auth);

                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log("Authenticated with Firebase:", user.uid);
                            // Initial rendering and live listeners
                            const newsRef = collection(db, `news`);
                            onSnapshot(newsRef, (snapshot) => {
                                newsData = [];
                                snapshot.forEach(doc => {
                                    newsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderNews();
                            });

                            const eventsRef = collection(db, `events`);
                            onSnapshot(eventsRef, (snapshot) => {
                                eventsData = [];
                                snapshot.forEach(doc => {
                                    eventsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderEvents();
                            });
                            
                            const adminsRef = collection(db, `admins`);
                            onSnapshot(adminsRef, (snapshot) => {
                                adminsData = [];
                                snapshot.forEach(doc => {
                                    adminsData.push({ id: doc.id, ...doc.data() });
                                });
                                renderAdmins();
                            });
                        } else {
                            console.log("Not authenticated with Firebase.");
                        }
                    });
                } catch (initError) {
                    console.error("Error initializing Firebase App:", initError);
                    statusIndicator.textContent = "Fel: Kunde inte ansluta till Firebase.";
                    statusIndicator.classList.remove('bg-green-500');
                    statusIndicator.classList.add('bg-red-500');
                }
            } else {
                statusIndicator.textContent = "Fel: Firebase-konfiguration saknas.";
                statusIndicator.classList.remove('bg-green-500');
                statusIndicator.classList.add('bg-red-500');
            }

            // Funktion för att hantera radering av nyheter/events
            async function deleteDocument(docId, collectionName) {
                if (!db || !isAdminLoggedIn) {
                    showModal('errorModal', "Du har inte behörighet att utföra denna åtgärd.");
                    return;
                }
                const docRef = doc(db, collectionName, docId);
                try {
                    await deleteDoc(docRef);
                    showModal('confirmationModal', `Posten har tagits bort från ${collectionName}.`);
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid borttagning av post:", error);
                    showModal('errorModal', "Ett fel uppstod när posten skulle tas bort. Kontrollera dina Firebase Security Rules.");
                }
            }
            
            // Funktion för att hantera radering av admins
            async function deleteAdmin(adminId) {
                if (!db || !isAdminLoggedIn) {
                    showModal('errorModal', "Du har inte behörighet att utföra denna åtgärd.");
                    return;
                }
                if (adminsData.length <= 1) {
                    showModal('errorModal', "Kan inte ta bort den sista administratören.");
                    return;
                }
                const adminToDelete = adminsData.find(a => a.id === adminId);
                if (adminToDelete.username === loggedInAdminUsername) {
                    showModal('errorModal', "Du kan inte ta bort dig själv.");
                    return;
                }
                const adminRef = doc(db, 'admins', adminId);
                try {
                    await deleteDoc(adminRef);
                    showModal('confirmationModal', "Admin har tagits bort.");
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid borttagning av admin:", error);
                    showModal('errorModal', "Ett fel uppstod när admin skulle tas bort.");
                }
            }

            // Händelsedelegation för "Ta bort"-knappar (nyheter och kalender)
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const docType = e.target.getAttribute('data-type');
                    const seriesId = e.target.getAttribute('data-series-id');
                    
                    if (docType === 'events' && seriesId) {
                        // Visa modal för radering av serie
                        document.getElementById('delete-event-message').textContent = 'Denna händelse är en del av en serie. Vill du radera enbart denna händelse eller hela serien?';
                        document.getElementById('deleteEventModal').classList.add('active');
                        document.getElementById('delete-single-event-btn').onclick = () => {
                            deleteDocument(docId, docType);
                            hideModal('deleteEventModal');
                        };
                        document.getElementById('delete-series-event-btn').onclick = async () => {
                            // Radera hela serien
                            const batch = writeBatch(db);
                            const q = query(collection(db, 'events'), where('seriesId', '==', seriesId));
                            const querySnapshot = await getDocs(q);
                            querySnapshot.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            showModal('confirmationModal', "Hela serien har tagits bort.");
                            setTimeout(() => hideModal('confirmationModal'), 2000);
                            hideModal('deleteEventModal');
                        };
                        document.getElementById('cancel-event-delete-btn').onclick = () => hideModal('deleteEventModal');
                    } else {
                        // Visa en allmän bekräftelsemodal istället för confirm()
                        document.getElementById('delete-confirmation-message').textContent = `Är du säker på att du vill ta bort denna ${docType === 'news' ? 'nyhet' : 'händelse'}?`;
                        document.getElementById('deleteConfirmationModal').classList.add('active');
                        
                        document.getElementById('confirm-delete-btn').onclick = () => {
                            deleteDocument(docId, docType);
                            hideModal('deleteConfirmationModal');
                        };
                        document.getElementById('cancel-delete-btn').onclick = () => hideModal('deleteConfirmationModal');
                    }
                }
            });
            
            // Händelsedelegation för "Ändra"-knappen
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-news-btn')) {
                    const docId = e.target.getAttribute('data-id');
                    const newsItem = newsData.find(item => item.id === docId);

                    if (newsItem) {
                        // Fyll i formuläret med befintlig data
                        document.getElementById('news-title').value = newsItem.title;
                        document.getElementById('news-content-editor').innerHTML = newsItem.content;
                        
                        // Spara ID för den nyhet som redigeras
                        editingNewsId = docId;
                        
                        // Ändra knapptext och navigera till admin-sidan
                        const addNewsBtn = document.getElementById('add-news-btn');
                        addNewsBtn.textContent = 'Spara ändringar';
                        addNewsBtn.classList.remove('bg-gray-400');
                        addNewsBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');

                        navigate('#admin');
                    }
                }
            });

            // Händelsedelegation för "Ta bort Admin"-knappar
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-admin-btn')) {
                    const adminId = e.target.getAttribute('data-id');
                    // Visa en allmän bekräftelsemodal istället för confirm()
                    document.getElementById('delete-confirmation-message').textContent = `Är du säker på att du vill ta bort denna administratör?`;
                    document.getElementById('deleteConfirmationModal').classList.add('active');
                    
                    document.getElementById('confirm-delete-btn').onclick = () => {
                        deleteAdmin(adminId);
                        hideModal('deleteConfirmationModal');
                    };
                    document.getElementById('cancel-delete-btn').onclick = () => hideModal('deleteConfirmationModal');
                }
            });
            
            // Hantera klick på editor-knapparna
            document.querySelectorAll('.editor-toolbar button').forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.dataset.command;
                    const editor = document.getElementById(button.parentElement.dataset.editorTarget);
                    if (editor) {
                        editor.focus();
                        if (command === 'createLink') {
                            const url = prompt("Ange URL för länken:");
                            if (!url) return;
                            let linkText = prompt("Ange länktext (lämna tomt för att visa URL):");
                            if (!linkText) linkText = url;
                            
                            const protocol = url.startsWith('http') ? '' : 'https://';
                            document.execCommand('insertHTML', false, `<a href="${protocol}${url}" target="_blank">${linkText}</a>`);
                        } else if (command === 'insertImage') {
                            // Visa den nya modalen för bildinfogning
                            showModal('insertImageModal', '');
                            const insertBtn = document.getElementById('insert-image-btn');
                            const cancelBtn = document.getElementById('cancel-image-btn');
                            const imageUrlInput = document.getElementById('image-url-input');
                            const imageSizeSelect = document.getElementById('image-size-select');

                            insertBtn.onclick = () => {
                                const imageUrl = imageUrlInput.value;
                                const imageSize = imageSizeSelect.value;
                                if (imageUrl) {
                                    let style = '';
                                    let maxWidth = '100%';
                                    if (imageSize === 'small') {
                                        maxWidth = '150px';
                                    } else if (imageSize === 'medium') {
                                        maxWidth = '400px';
                                    } else if (imageSize === 'large') {
                                        maxWidth = '800px';
                                    }
                                    style = `style="max-width: ${maxWidth}; height: auto;"`;
                                    
                                    document.execCommand('insertHTML', false, `<img src="${imageUrl}" alt="Bild" ${style}>`);
                                }
                                hideModal('insertImageModal');
                            };
                            cancelBtn.onclick = () => {
                                hideModal('insertImageModal');
                            };
                        } else {
                            document.execCommand(command, false);
                        }
                    }
                });
            });

            // Hantera att knappar blir aktiva/inaktiva baserat på markören
            document.querySelectorAll('.editor-content').forEach(editor => {
                editor.addEventListener('mouseup', () => updateToolbarButtons(editor));
                editor.addEventListener('keyup', () => updateToolbarButtons(editor));
            });

            function updateToolbarButtons(editor) {
                const toolbar = editor.previousElementSibling;
                if (!toolbar) return;
                const boldButton = toolbar.querySelector('[data-command="bold"]');
                const italicButton = toolbar.querySelector('[data-command="italic"]');
                
                if (document.queryCommandState('bold')) {
                    boldButton.classList.add('active');
                } else {
                    boldButton.classList.remove('active');
                }
                
                if (document.queryCommandState('italic')) {
                    italicButton.classList.add('active');
                } else {
                    italicButton.classList.remove('active');
                }
            }

            // Funktion för att navigera och uppdatera admin-status
            function navigate(hash) {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.querySelector(hash);
                if (targetPage) {
                    targetPage.classList.add('active');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    document.getElementById('hem').classList.add('active');
                }
            }

            // --- MODAL EVENT LYSSNARE ---
            const errorModal = document.getElementById('errorModal');
            const closeErrorModalBtn = document.getElementById('close-error-modal');
            if (closeErrorModalBtn) {
                closeErrorModalBtn.addEventListener('click', () => {
                    hideModal('errorModal');
                });
            }
            if (errorModal) {
                errorModal.addEventListener('click', (event) => {
                    if (event.target === errorModal) {
                        hideModal('errorModal');
                    }
                });
            }

            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.addEventListener('click', (event) => {
                    if (event.target === confirmationModal) {
                        hideModal('confirmationModal');
                    }
                });
            }

            // Händelsedelegation för nyheter och kalender i hemvyn
            document.addEventListener('click', (e) => {
                // Klick på kalenderhändelse
                const calendarPost = e.target.closest('.home-calendar-post');
                if (calendarPost) {
                    const id = calendarPost.getAttribute('data-id');
                    navigate('#kalender');
                    setTimeout(() => {
                        const targetEvent = document.getElementById(`event-${id}`);
                        if (targetEvent) {
                            targetEvent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            if (targetEvent.getAttribute('data-expanded') === 'false') {
                                targetEvent.click();
                            }
                        }
                    }, 100);
                }
                // Klick på nyhet
                const newsPost = e.target.closest('.home-news-post');
                if (newsPost) {
                    const id = newsPost.getAttribute('data-id');
                    navigate('#nyheter');
                    setTimeout(() => {
                        const targetNews = document.getElementById(`news-${id}`);
                        if (targetNews) {
                            targetNews.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                }
            });
            
            document.querySelectorAll('nav a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const hash = e.target.getAttribute('href');
                    history.pushState(null, '', hash);
                    navigate(hash);
                });
            });

            window.addEventListener('popstate', () => {
                navigate(window.location.hash || '#hem');
            });
            
            navigate(window.location.hash || '#hem');

            // --- ADMINPANELENS LOGIK ---
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminUsernameInput = document.getElementById('admin-username');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminLoginPanel = document.getElementById('admin-login-panel');
            const adminPanel = document.getElementById('admin-panel');
            const adminUserInfo = document.getElementById('admin-user-info');
            const addAdminForm = document.getElementById('add-admin-form');
            const newAdminUsernameInput = document.getElementById('new-admin-username');
            const newAdminPasswordInput = document.getElementById('new-admin-password');
            const newsAddBtn = document.getElementById('add-news-btn');
            const eventAddBtn = document.getElementById('add-event-btn');
            const newsContentEditor = document.getElementById('news-content-editor');
            const eventDescriptionEditor = document.getElementById('event-description-editor');

            // Toggle för återkommande händelser
            const isRecurringCheckbox = document.getElementById('is-recurring');
            const singleEventFields = document.getElementById('single-event-fields');
            const recurringEventFields = document.getElementById('recurring-event-fields');
            isRecurringCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    singleEventFields.classList.add('hidden');
                    recurringEventFields.classList.remove('hidden');
                    document.getElementById('event-date').removeAttribute('required');
                    document.getElementById('start-date').setAttribute('required', 'required');
                    document.getElementById('end-date').setAttribute('required', 'required');
                } else {
                    singleEventFields.classList.remove('hidden');
                    recurringEventFields.classList.add('hidden');
                    document.getElementById('event-date').setAttribute('required', 'required');
                    document.getElementById('start-date').removeAttribute('required');
                    document.getElementById('end-date').removeAttribute('required');
                }
            });

            loginBtn.addEventListener('click', async () => {
                const username = adminUsernameInput.value;
                const password = adminPasswordInput.value;
                let foundAdmin = false;
                let adminToLog = {};

                // Hantera den hårdkodade admin-användaren
                if (username === 'admin' && password === 'admin') {
                    foundAdmin = true;
                    adminToLog = { username: 'admin' };
                    // Lägg till den hårdkodade admin i databasen om den inte redan finns
                    try {
                        const adminsRef = collection(db, 'admins');
                        const q = query(adminsRef, where('username', '==', 'admin'));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) {
                            await addDoc(adminsRef, { username: 'admin', password: 'admin' });
                            console.log('Hårdkodad admin skapad i databasen.');
                        }
                    } catch (error) {
                        console.error('Fel vid hantering av hårdkodad admin:', error);
                    }
                } else {
                    // Sök efter admin i databasen
                    try {
                        const adminsRef = collection(db, 'admins');
                        const q = query(adminsRef, where('username', '==', username), where('password', '==', password));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            foundAdmin = true;
                            querySnapshot.forEach(doc => {
                                adminToLog = { ...doc.data() };
                            });
                        }
                    } catch (error) {
                        console.error('Fel vid sökning efter admin:', error);
                    }
                }

                if (foundAdmin) {
                    isAdminLoggedIn = true;
                    loggedInAdminUsername = adminToLog.username;
                    adminLoginPanel.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    if (auth && auth.currentUser) {
                        adminUserInfo.textContent = `Du är inloggad som administratör (Användar-ID: ${auth.currentUser.uid}, Admin: ${loggedInAdminUsername})`;
                    }
                    newsAddBtn.disabled = false;
                    newsAddBtn.classList.remove('bg-gray-400');
                    newsAddBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    eventAddBtn.disabled = false;
                    eventAddBtn.classList.remove('bg-gray-400');
                    eventAddBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    
                    // Manuell uppdatering av UI efter inloggning för att visa delete-knappar
                    renderNews();
                    renderEvents();
                    renderAdmins();
                } else {
                    showModal('errorModal', 'Felaktigt användarnamn eller lösenord!');
                }
            });

            logoutBtn.addEventListener('click', () => {
                isAdminLoggedIn = false;
                loggedInAdminUsername = '';
                adminLoginPanel.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                adminUsernameInput.value = '';
                adminPasswordInput.value = '';
                newsAddBtn.disabled = true;
                newsAddBtn.classList.add('bg-gray-400');
                newsAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                eventAddBtn.disabled = true;
                eventAddBtn.classList.add('bg-gray-400');
                eventAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                renderNews();
                renderEvents();
                renderAdmins();
                navigate('#hem');
            });


            addAdminForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten.");
                    return;
                }
                const newAdmin = {
                    username: newAdminUsernameInput.value,
                    password: newAdminPasswordInput.value
                };
                
                try {
                    await addDoc(collection(db, `admins`), newAdmin);
                    addAdminForm.reset();
                    showModal('confirmationModal', "Ny admin har lagts till!");
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid tillägg av admin:", error);
                    showModal('errorModal', "Ett fel uppstod när admin skulle läggas till.");
                }
            });


            // --- FORMULÄR FÖR ATT LÄGGA TILL DATA TILL FIREBASE ---
            const addNewsForm = document.getElementById('add-news-form');
            addNewsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                
                const newsTitle = document.getElementById('news-title').value;
                const newsContent = document.getElementById('news-content-editor').innerHTML;
                
                const newsObject = {
                    title: newsTitle,
                    content: newsContent,
                    createdAt: serverTimestamp()
                };

                try {
                    if (editingNewsId) {
                        // Uppdatera befintlig nyhet
                        await updateDoc(doc(db, 'news', editingNewsId), newsObject);
                        console.log("Nyhet uppdaterad!");
                        showModal('confirmationModal', "Nyhet har uppdaterats!");
                    } else {
                        // Lägg till ny nyhet
                        await addDoc(collection(db, `news`), newsObject);
                        console.log("Nyhet tillagd!");
                        showModal('confirmationModal', "Nyhet har lagts till!");
                    }
                    
                    // Återställ formuläret och variabler
                    addNewsForm.reset();
                    document.getElementById('news-content-editor').innerHTML = '';
                    editingNewsId = null;
                    newsAddBtn.textContent = 'Lägg till';
                    newsAddBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    newsAddBtn.classList.add('bg-gray-400');
                    
                    setTimeout(() => hideModal('confirmationModal'), 2000);
                } catch (error) {
                    console.error("Fel vid hantering av nyhet:", error);
                    showModal('errorModal', "Ett fel uppstod. Kontrollera dina Firebase Security Rules.");
                }
            });

            const addEventForm = document.getElementById('add-event-form');
            addEventForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) {
                    showModal('errorModal', "Databasen är inte ansluten. Vänligen ladda om sidan.");
                    return;
                }
                
                const newEvent = {
                    title: document.getElementById('event-title').value,
                    description: document.getElementById('event-description-editor').innerHTML,
                    createdAt: serverTimestamp()
                };

                const isRecurring = document.getElementById('is-recurring').checked;
                const eventsCollection = collection(db, `events`);

                if (isRecurring) {
                    const startDate = document.getElementById('start-date').value;
                    const endDate = document.getElementById('end-date').value;
                    const weekday = parseInt(document.getElementById('weekday-select').value, 10);
                    
                    if (!startDate || !endDate) {
                        showModal('errorModal', "Start- och slutdatum måste anges för återkommande händelser.");
                        return;
                    }

                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    const seriesId = `series-${Date.now()}`;
                    const batch = writeBatch(db);
                    
                    for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() === weekday) {
                            const newDate = d.toISOString().split('T')[0];
                            const eventRef = doc(eventsCollection);
                            batch.set(eventRef, { ...newEvent, date: newDate, seriesId: seriesId });
                        }
                    }
                    
                    try {
                        await batch.commit();
                        console.log("Återkommande händelser tillagda!");
                        addEventForm.reset();
                        document.getElementById('event-description-editor').innerHTML = '';
                        showModal('confirmationModal', "Återkommande händelser har lagts till!");
                        setTimeout(() => hideModal('confirmationModal'), 2000);
                    } catch (error) {
                        console.error("Fel vid tillägg av händelse:", error);
                        showModal('errorModal', "Ett fel uppstod när händelsen skulle läggas till. Kontrollera dina Firebase Security Rules.");
                    }
                } else {
                    const eventDate = document.getElementById('event-date').value;
                    if (!eventDate) {
                        showModal('errorModal', "Datum måste anges för enskild händelse.");
                        return;
                    }

                    try {
                        await addDoc(eventsCollection, { ...newEvent, date: eventDate });
                        console.log("Händelse tillagd!");
                        addEventForm.reset();
                        document.getElementById('event-description-editor').innerHTML = '';
                        showModal('confirmationModal', "Händelse har lagts till!");
                        setTimeout(() => hideModal('confirmationModal'), 2000);
                    } catch (error) {
                        console.error("Fel vid tillägg av händelse:", error);
                        showModal('errorModal', "Ett fel uppstod när händelsen skulle läggas till. Kontrollera dina Firebase Security Rules.");
                    }
                }
            });
        });
    </script>
</body>
</html>
